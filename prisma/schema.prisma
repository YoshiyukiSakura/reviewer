// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public", "reviewer"]
}

// Review model - represents a code review session
model Review {
  id          String             @id @default(cuid())
  title       String
  description String?
  status      ReviewerReviewStatus @default(PENDING)

  // Source information (e.g., pull request, commit, etc.)
  sourceType String? // e.g., "pull_request", "commit", "file"
  sourceId   String? // External reference ID
  sourceUrl  String? // URL to the source

  // Author information
  authorId   String
  authorName String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  comments ReviewComment[]

  @@map("reviewer_review")
  @@schema("reviewer")
  @@index([authorId])
  @@index([status])
  @@index([createdAt])
}

// ReviewComment model - represents a comment on a review
model ReviewComment {
  id      String @id @default(cuid())
  content String

  // Position information for inline comments
  filePath  String? // File path for file-level comments
  lineStart Int? // Starting line number
  lineEnd   Int? // Ending line number (for multi-line comments)

  // Comment metadata
  isResolved Boolean              @default(false)
  severity   ReviewerCommentSeverity?

  // Author information
  authorId   String
  authorName String?

  // Parent comment for threaded discussions
  parentId String?
  parent   ReviewComment?  @relation("CommentThread", fields: [parentId], references: [id])
  replies  ReviewComment[] @relation("CommentThread")

  // Review relation
  reviewId String
  review   Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("reviewer_reviewcomment")
  @@schema("reviewer")
  @@index([reviewId])
  @@index([authorId])
  @@index([parentId])
  @@index([filePath])
}

// Enum for review status (prefixed to avoid conflict)
enum ReviewerReviewStatus {
  PENDING
  IN_PROGRESS
  APPROVED
  REJECTED
  CHANGES_REQUESTED
  CLOSED

  @@schema("reviewer")
}

// Enum for comment severity (prefixed to avoid conflict)
enum ReviewerCommentSeverity {
  INFO
  SUGGESTION
  WARNING
  ERROR
  CRITICAL

  @@schema("reviewer")
}

// Enum for recommendation type
enum RecommendationType {
  MERGE
  NEEDS_CHANGES
  REJECT

  @@schema("reviewer")
}

// User model - represents a registered user
model User {
  id           String    @id @default(cuid())
  email        String    @unique
  name         String?
  password     String?
  avatarUrl    String?
  slackUserId  String?   @unique

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  notificationSettings NotificationSettings?

  @@map("reviewer_user")
  @@schema("reviewer")
  @@index([email])
}

// NotificationSettings model - stores user notification preferences
model NotificationSettings {
  id                  String   @id @default(cuid())
  userId              String   @unique
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // General notifications
  emailNotifications  Boolean  @default(true)
  pushNotifications   Boolean  @default(true)

  // Review notifications
  reviewAssignments   Boolean  @default(true)
  reviewComments      Boolean  @default(true)
  reviewStatusChanges Boolean  @default(true)

  // Digest
  weeklyDigest        Boolean  @default(false)

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("reviewer_notificationsettings")
  @@schema("reviewer")
  @@index([userId])
}

// TestReport model - represents a test report
model TestReport {
  id          String   @id @default(cuid())
  title       String
  description String?

  // Link to execution/review
  executionId String?

  // Recommendation
  recommendation RecommendationType
  recommendationReason String?

  // Task statistics
  totalTasks      Int      @default(0)
  completedTasks  Int      @default(0)
  failedTasks     Int      @default(0)
  skippedTasks    Int      @default(0)

  // Traceability snapshot
  repositoryName   String?
  repositoryUrl    String?
  branchName       String?
  commitSha        String?
  pullRequestId    String?
  pullRequestUrl   String?

  // AI generated content
  summary          String?
  overallAnalysis  String?
  keyFindings      String[]
  concerns         String[]
  positives        String[]
  suggestions      String[]

  // Scoring
  score            Float?
  maxScore         Float?

  // Acceptance suggestion
  acceptanceSuggestion String?

  // Metadata
  testDuration     Int?     // Duration in milliseconds
  testRunner       String?

  // Author information
  authorId         String?
  authorName       String?

  // Timestamps
  executedAt       DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@map("reviewer_testreport")
  @@schema("reviewer")
  @@index([authorId])
  @@index([recommendation])
  @@index([executedAt])
  @@index([executionId])
}